<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>SpotHere</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key=pk.eyJ1IjoiZ3JlZW5hZG8iLCJhIjoiY21sODM2N3BtMDJ2aDNncXMwMzZtMmN0cCJ9.VJ2kEfxu4WsfFnC0aUtRHQ "></script>

<!-- PayPal SDK -->
<script src="https://www.paypal.com/sdk/js?client-id=AYoQPCUp5QBgWA6yXEpF2FgmjvkLupw5iZwlz_QBAHaByjr6dojQ6komZKrAqFd8en24rgRo1y6VlyxB&currency=EUR"></script>

<!-- Google reCAPTCHA -->
<script src="https://www.google.com/recaptcha/api.js" async defer></script>

<style>
body { font-family: 'Segoe UI', Arial, sans-serif; margin:0; padding:0; background:#f0f2f5; }
#map { height: 450px; width: 100%; border-radius:12px; margin-bottom:30px; }
.container { width: 90%; max-width: 900px; margin:auto; padding:25px; background:#fff; border-radius:12px; box-shadow:0 5px 20px rgba(0,0,0,0.1); }
h1,h2 { text-align:center; color:#333; }
input, button { padding:12px; margin:8px 0; width:100%; border-radius:8px; border:1px solid #ccc; font-size:16px; }
input:focus, button:focus { outline:none; border-color:#0070f3; }
button { background:#0070f3; color:#fff; font-weight:bold; cursor:pointer; transition:0.3s; }
button:hover { background:#005fd1; }
#paypal-button-container { margin-top:20px; }
footer { text-align:center; font-size:13px; margin-top:50px; color:#777; }
a { color:#0070f3; text-decoration:none; margin:0 5px; }
a:hover { text-decoration:underline; }
</style>
</head>
<body>

<div class="container">
  <h1>SpotHere</h1>
  <div id="map"></div>

  <h2>Додати свою точку</h2>
  <form id="pointForm">
    <input type="text" id="city" placeholder="Місто" required>
    <input type="text" id="country" placeholder="Країна" required>
    <input type="text" id="nickname" placeholder="Нікнейм">
    <div class="g-recaptcha" data-sitekey="6LcEdWAsAAAAAEOn1pvxAmZZMicnqhNv778PBd76"></div>
    <button type="submit">Оплатити та додати точку</button>
  </form>

  <div id="paypal-button-container"></div>
</div>

<footer>
  <a href="#">Правила</a> | <a href="#">Політика конфіденційності</a>
</footer>

<script>
let map;
let userLatLng;
const markers = [];

// Ініціалізація карти з сучасними маркерами
function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    center: { lat: 50.4501, lng: 30.5234 },
    zoom: 5
  });

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (position) => {
        userLatLng = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };
        map.setCenter(userLatLng);
        map.setZoom(10);
      },
      () => console.log('Геолокація недоступна')
    );
  }

  loadPoints();
}

// Завантаження точок з Google Web App
function loadPoints() {
  fetch('https://script.google.com/macros/s/AKfycbxjZ1HD3C44mnrBIre54YrmXk_AGcPPqjQ5EaCrqNmFl6JzpqibkTFEdKjbWaxQlJO_/exec')
    .then(res => res.json())
    .then(data => {
      // видаляємо попередні маркери
      markers.forEach(m => m.setMap(null));
      markers.length = 0;

      data.forEach(point => {
        const marker = new google.maps.Marker({
          position: { lat: parseFloat(point.lat), lng: parseFloat(point.lng) },
          map: map,
          title: point.nickname || point.city,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 8,
            fillColor: '#0070f3',
            fillOpacity: 0.9,
            strokeWeight: 2,
            strokeColor: '#fff'
          }
        });
        markers.push(marker);
      });
    })
    .catch(err => console.error(err));
}

window.onload = initMap;

// Обробка форми + PayPal
const form = document.getElementById('pointForm');
form.addEventListener('submit', function(e) {
  e.preventDefault();

  const recaptcha = grecaptcha.getResponse();
  if (!recaptcha) { alert('Підтвердьте, що ви не робот'); return; }

  const city = document.getElementById('city').value;
  const country = document.getElementById('country').value;
  const nickname = document.getElementById('nickname').value;

  paypal.Buttons({
    createOrder: function(data, actions) {
      return actions.order.create({
        purchase_units: [{
          amount: { value: 1 }
        }]
      });
    },
    onApprove: function(data, actions) {
      return actions.order.capture().then(function(details) {
        alert('Оплата пройшла! Дякуємо, ' + details.payer.name.given_name);

        fetch('https://script.google.com/macros/s/AKfycbxjZ1HD3C44mnrBIre54YrmXk_AGcPPqjQ5EaCrqNmFl6JzpqibkTFEdKjbWaxQlJO_/exec ', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            city: city,
            country: country,
            nickname: nickname,
            lat: userLatLng ? userLatLng.lat : map.getCenter().lat(),
            lng: userLatLng ? userLatLng.lng : map.getCenter().lng(),
            payerName: details.payer.name.given_name,
            payerEmail: details.payer.email_address,
            amount: details.purchase_units[0].amount.value,
            date: new Date()
          })
        })
        .then(res => res.json())
        .then(data => { console.log('Точка додана:', data); loadPoints(); })
        .catch(err => console.error(err));
      });
    }
  }).render('#paypal-button-container');
});
</script>
</body>
</html>
