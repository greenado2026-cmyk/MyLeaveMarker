<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>LeaveMyMark</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key=pk.eyJ1IjoiZ3JlZW5hZG8iLCJhIjoiY21sODhzcGF4MDRpYjNncXMwMGExdXk3OSJ9.TSivlk-HgO9qfHw0p8ShgQ"></script>

<!-- PayPal SDK -->
<script src="https://www.paypal.com/sdk/js?client-id=AYoQPCUp5QBgWA6yXEpF2FgmjvkLupw5iZwlz_QBAHaByjr6dojQ6komZKrAqFd8en24rgRo1y6VlyxB"></script>

<!-- Google reCAPTCHA -->
<script src="https://www.google.com/recaptcha/api.js" async defer></script>

<style>
body { margin:0; padding:0; font-family:'Segoe UI',Arial,sans-serif; background:#f5f6fa; }
header { background:#0070f3; color:#fff; padding:20px; text-align:center; border-radius:0 0 12px 12px; }
header h1 { margin:0; font-size:2em; }
header p { margin:5px 0 0; font-size:1.1em; font-weight:400; }
#map { width:100%; height:500px; border-radius:12px; margin:20px 0; }
.container { max-width:900px; margin:auto; padding:20px; background:#fff; border-radius:12px; box-shadow:0 5px 20px rgba(0,0,0,0.1); }
input, button { width:100%; padding:12px; margin:8px 0; border-radius:8px; border:1px solid #ccc; font-size:16px; }
button { background:#0070f3; color:#fff; font-weight:bold; cursor:pointer; transition:0.3s; }
button:hover { background:#005fd1; }
#paypal-button-container { margin-top:20px; }
footer { text-align:center; font-size:13px; margin-top:40px; color:#777; }
a { color:#0070f3; text-decoration:none; margin:0 5px; }
a:hover { text-decoration:underline; }
</style>
</head>
<body>

<header>
  <h1>LeaveMyMark</h1>
  <p>Your spot on the map</p>
</header>

<div class="container">
  <div id="map"></div>

  <input type="text" id="nickname" placeholder="Enter your nickname" />
  <div class="g-recaptcha" data-sitekey="6LcEdWAsAAAAAEOn1pvxAmZZMicnqhNv778PBd76"></div>

  <div id="paypal-button-container"></div>
</div>

<footer>
  <a href="#">Terms</a> | <a href="#">Privacy Policy</a>
</footer>

<script>
let map;
let userLatLng;

// Initialize map
function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    center: {lat: 40.7128, lng: -74.0060}, // default center (New York)
    zoom: 12
  });

  // Get user location
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (position) => {
        userLatLng = {lat: position.coords.latitude, lng: position.coords.longitude};
        map.setCenter(userLatLng);

        new google.maps.Marker({
          position: userLatLng,
          map: map,
          title: "You are here",
          icon: { path: google.maps.SymbolPath.CIRCLE, scale:10, fillColor:"#0070f3", fillOpacity:0.8, strokeWeight:2, strokeColor:"#fff"}
        });
      },
      () => { console.log("Geolocation not available, using default location"); }
    );
  }
}

// PayPal button
paypal.Buttons({
  style: { layout: 'vertical', color: 'blue', shape: 'pill', label:'pay'},
  createOrder: function(data, actions) {
    return actions.order.create({
      purchase_units: [{ amount: { value: '1' } }]
    });
  },
  onApprove: function(data, actions) {
    return actions.order.capture().then(function(details){
      alert('Payment successful! Thank you, ' + details.payer.name.given_name);

      // Send data to Google Web App
      const nickname = document.getElementById('nickname').value;
      fetch('https://script.google.com/macros/s/AKfycbxjZ1HD3C44mnrBIre54YrmXk_AGcPPqjQ5EaCrqNmFl6JzpqibkTFEdKjbWaxQlJO_/exec', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          nickname: nickname,
          lat: userLatLng ? userLatLng.lat : map.getCenter().lat(),
          lng: userLatLng ? userLatLng.lng : map.getCenter().lng(),
          payerName: details.payer.name.given_name,
          payerEmail: details.payer.email_address,
          amount: details.purchase_units[0].amount.value,
          date: new Date()
        })
      }).then(res => res.json())
        .then(data => console.log('Spot added:', data))
        .catch(err => console.error(err));
    });
  }
}).render('#paypal-button-container');

window.onload = initMap;
</script>

</body>
</html>
